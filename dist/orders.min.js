!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Orders=t()}(this,function(){$p.modifiers.push(function(e){var t=e.cat.contracts;t.sql_selection_list_flds=function(e){return"SELECT _t_.ref, _t_.`_deleted`, _t_.is_folder, _t_.id, _t_.name as presentation, _k_.synonym as contract_kind, _m_.synonym as mutual_settlements, _o_.name as organization, _p_.name as partner, case when _t_.ref = '"+e+"' then 0 else 1 end as is_initial_value FROM cat_contracts AS _t_ left outer join cat_organizations as _o_ on _o_.ref = _t_.organization left outer join cat_partners as _p_ on _p_.ref = _t_.owner left outer join enm_mutual_contract_settlements as _m_ on _m_.ref = _t_.mutual_settlements left outer join enm_contract_kinds as _k_ on _k_.ref = _t_.contract_kind %3 %4 LIMIT 300"},t.by_partner_and_org=function(a,n,i){i||(i=e.enm.contract_kinds.СПокупателем);var r=t.find_rows({owner:a,organization:n,contract_kind:i});return r.sort(function(e,t){return e.date>t.date}),r.length?r[0]:t.get()}}),$p.modifiers.push(function(e){var t=e.cat.partners;t.sql_selection_where_flds=function(e){return" OR inn LIKE '"+e+"' OR name_full LIKE '"+e+"' OR name LIKE '"+e+"'"},t._obj_constructor.prototype.__define({addr:{get:function(){return this.contact_information._obj.reduce(function(t,a){return a.kind==e.cat.contact_information_kinds.predefined("ЮрАдресКонтрагента")&&a.presentation?a.presentation:t?t:!a.presentation||a.kind!=e.cat.contact_information_kinds.predefined("ФактАдресКонтрагента")&&a.kind!=e.cat.contact_information_kinds.predefined("ПочтовыйАдресКонтрагента")?void 0:a.presentation},"")}},phone:{get:function(){return this.contact_information._obj.reduce(function(t,a){return a.kind==e.cat.contact_information_kinds.predefined("ТелефонКонтрагента")&&a.presentation?a.presentation:t?t:a.kind==e.cat.contact_information_kinds.predefined("ТелефонКонтрагентаМобильный")&&a.presentation?a.presentation:void 0},"")}},long_presentation:{get:function(){var e=this.name_full||this.name,t=this.addr,a=this.phone;return this.inn&&(e+=", ИНН"+this.inn),this.kpp&&(e+=", КПП"+this.kpp),t&&(e+=", "+t),a&&(e+=", "+a),e}}})}),$p.modifiers.push(function(e){e.cat.users_acl.__define({load_array:{value:function(t,a){var n,i,r,o=[];for(var s in t){if(n=e.utils.fix_guid(t[s]),r=t[s].acl,r&&delete t[s].acl,(i=this.by_ref[n])?(i.is_new()||a)&&(i._mixin(t[s]),i._set_loaded()):(i=new this._obj_constructor(t[s],this),a&&i._set_loaded()),r&&!i._acl){var c={};for(var s in r){c.__define(s,{value:{},writable:!1});for(var l in r[s])c[s].__define(l,{value:r[s][l],writable:!1})}i.__define({_acl:{value:c,writable:!1}})}o.push(i)}return o}}}),e.cat.users_acl._obj_constructor.prototype.__define({role_available:{value:function(e){return this.acl_objs._obj.some(function(t){return t.type==e})}},partners_uids:{get:function(){var t=[];return this.acl_objs.each(function(a){a.acl_obj instanceof e.cat.partners._obj_constructor&&t.push(a.acl_obj.ref)}),t}}})}),$p.modifiers.push(function(e){e.on({pouch_load_data_loaded:function a(){e.off(a),e.cch.predefined_elmnts.pouch_find_rows({_raw:!0,_top:500,_skip:0}).then(function(t){var a={};t.forEach(function(t){if(t.is_folder&&t.synonym){var n=t._id.split("|")[1];a[n]=t.synonym,e.job_prm.__define(t.synonym,{value:{}})}}),t.forEach(function(t){if(!t.is_folder&&t.synonym&&a[t.parent]&&!e.job_prm[a[t.parent]][t.synonym]){var n,i;t.type.is_ref&&(i=t.type.types[0].split("."),n=e[i[0]][i[1]]),t.list==-1?e.job_prm[a[t.parent]].__define(t.synonym,{value:function(){var e={};return t.elmnts.forEach(function(t){e[t.elm]=n?n.get(t.value,!1):t.value}),e}()}):t.list?e.job_prm[a[t.parent]].__define(t.synonym,{value:t.elmnts.map(function(e){return n?n.get(e.value,!1):e.value})}):(e.job_prm[a[t.parent]].hasOwnProperty(t.synonym)&&delete e.job_prm[a[t.parent]][t.synonym],e.job_prm[a[t.parent]].__define(t.synonym,{value:n?n.get(t.value,!1):t.value,configurable:!0}))}})}).then(function(){setTimeout(function(){e.eve.callEvent("predefined_elmnts_inited")},100)})}});var t=e.cch.predefined_elmnts;delete t._obj_constructor.prototype.value,t._obj_constructor.prototype.__define({value:{get:function(){var t,a=this.type,n=this._obj?this._obj.value:"";return this._obj.is_folder?"":"object"==typeof n?n:a.is_ref?a.digits&&"number"==typeof n?n:a.hasOwnProperty("str_len")&&!e.utils.is_guid(n)?n:(t=e.md.value_mgr(this._obj,"value",a))?e.utils.is_data_mgr(t)?t.get(n,!1):e.utils.fetch_type(n,t):n?(console.log(["value",a,this._obj]),null):this.characteristic.clr:a.date_part?e.utils.fix_date(this._obj.value,!0):a.digits?e.utils.fix_number(this._obj.value,!a.hasOwnProperty("str_len")):"boolean"==a.types[0]?e.utils.fix_boolean(this._obj.value):this._obj.value||""},set:function(t){this._obj.value!==t&&(Object.getNotifier(this).notify({type:"update",name:"value",oldValue:this._obj.value}),this._obj.value=e.utils.is_data_obj(t)?t.ref:t,this._data._modified=!0)}}}),t.form_obj=function(e,t){var a,n;return this.constructor.prototype.form_obj.call(this,e,t).then(function(e){if(e)return a=e.o,n=e.wnd,e})}}),$p.modifiers.push(function(e){var t=e.cch.properties;t.check_mandatory=function(t,a){var n,i;for(n in t)if(i=t[n],i.param.mandatory&&(!i.value||i.value.empty()))return e.msg.show_msg({type:"alert-error",text:e.msg.bld_empty_param+i.param.presentation,title:a||e.msg.bld_title}),!0},t.slist=function(t,a){var n,i,r,o=[],s=this.get(t);if(s&&s.type.is_ref)for(n in s.type.types)s.type.types[n].indexOf(".")>-1&&(i=s.type.types[n].split("."),r=e[i[0]][i[1]],r&&(a&&(a.mgr=r),"enm.open_directions"==r.class_name?r.get_option_list().forEach(function(t){t.value&&t.value!=e.enm.tso.folding&&o.push(t)}):r.class_name.indexOf("enm.")==-1&&r.metadata().has_owners?r.find_rows({owner:t},function(e){o.push({value:e.ref,text:e.presentation})}):o=r.get_option_list()));return o}}),$p.modifiers.push(function(e){var t=e.doc.buyers_order;t.on("after_create",function(t){var a=e.current_acl.acl_objs,n=this;return a.find_rows({by_default:!0,type:e.cat.organizations.metadata().obj_presentation||e.cat.organizations.metadata().name},function(e){return n.organization=e.acl_obj,!1}),a.find_rows({by_default:!0,type:e.cat.divisions.metadata().obj_presentation||e.cat.divisions.metadata().name},function(e){return n.department=e.acl_obj,!1}),a.find_rows({by_default:!0,type:e.cat.partners.metadata().obj_presentation||e.cat.partners.metadata().name},function(e){return n.partner=e.acl_obj,!1}),n.contract=e.cat.contracts.by_partner_and_org(n.partner,n.organization),n.manager=e.current_user,n.obj_delivery_state=e.enm.obj_delivery_states.Черновик,n.new_number_doc()}),t.on("before_save",function(t){if(this.posted){if(this.obj_delivery_state==e.enm.obj_delivery_states.Отклонен||this.obj_delivery_state==e.enm.obj_delivery_states.Отозван||this.obj_delivery_state==e.enm.obj_delivery_states.Шаблон)return e.msg.show_msg({type:"alert-warning",text:"Нельзя провести заказ со статусом<br/>'Отклонён', 'Отозван' или 'Шаблон'",title:this.presentation}),!1;this.obj_delivery_state!=e.enm.obj_delivery_states.Подтвержден&&(this.obj_delivery_state=e.enm.obj_delivery_states.Подтвержден)}else this.obj_delivery_state==e.enm.obj_delivery_states.Подтвержден&&(this.obj_delivery_state=e.enm.obj_delivery_states.Отправлен);this.doc_amount=this.goods.aggregate([],["amount"]).round(2)+this.services.aggregate([],["amount"]).round(2),this._obj.partner_name=this.partner.name}),t.on("value_change",function(t){"organization"==t.field&&this.contract.organization!=t.value?this.contract=e.cat.contracts.by_partner_and_org(this.partner,t.value):"partner"==t.field&&this.contract.owner!=t.value?this.contract=e.cat.contracts.by_partner_and_org(t.value,this.organization):"goods"==t.tabular_section&&("nom"==t.field||"characteristic"==t.field||"price"!=t.field&&"price_internal"!=t.field&&"quantity"!=t.field&&"discount_percent"!=t.field&&"discount_percent_internal"!=t.field||(t.row[t.field]=t.value,t.row.amount=(t.row.price*((100-t.row.discount_percent)/100)*t.row.quantity).round(2),this.doc_amount=this.goods.aggregate([],["amount"]).round(2)+this.services.aggregate([],["amount"]).round(2)))}),t._obj_constructor.prototype.__define({doc_currency:{get:function(){var t=this.contract.settlements_currency;return t.empty()?e.job_prm.pricing.main_currency:t}},print_data:{get:function(){var t=this.organizational_unit&&!this.organizational_unit.empty()&&this.organizational_unit._manager==cat.organization_bank_accounts?this.organizational_unit:this.organization.main_bank_account,a=[],n={"АдресДоставки":this.shipping_address,"ВалютаДокумента":this.doc_currency.presentation,"ДатаЗаказаФорматD":e.moment(this.date).format("L"),"ДатаЗаказаФорматDD":e.moment(this.date).format("LL"),"ДатаТекущаяФорматD":e.moment().format("L"),"ДатаТекущаяФорматDD":e.moment().format("LL"),"ДоговорДатаФорматD":e.moment(this.contract.date.valueOf()==e.utils.blank.date.valueOf()?this.date:this.contract.date).format("L"),"ДоговорДатаФорматDD":e.moment(this.contract.date.valueOf()==e.utils.blank.date.valueOf()?this.date:this.contract.date).format("LL"),"ДоговорНомер":this.contract.number_doc?this.contract.number_doc:this.number_doc,"ДоговорСрокДействия":e.moment(this.contract.validity).format("L"),"ЗаказНомер":this.number_doc,"Контрагент":this.partner.presentation,"КонтрагентОписание":this.partner.long_presentation,"КонтрагентДокумент":"","КонтрагентКЛДолжность":"","КонтрагентКЛДолжностьРП":"","КонтрагентКЛИмя":"","КонтрагентКЛИмяРП":"","КонтрагентКЛК":"","КонтрагентКЛОснованиеРП":"","КонтрагентКЛОтчество":"","КонтрагентКЛОтчествоРП":"","КонтрагентКЛФамилия":"","КонтрагентКЛФамилияРП":"","КонтрагентЮрФизЛицо":"","КратностьВзаиморасчетов":this.settlements_multiplicity,"КурсВзаиморасчетов":this.settlements_course,"ЛистКомплектацииГруппы":"","ЛистКомплектацииСтроки":"","Организация":this.organization.presentation,"ОрганизацияГород":this.organization.contact_information._obj.reduce(function(e,t){return e||t.city},"")||"Москва","ОрганизацияАдрес":this.organization.contact_information._obj.reduce(function(t,a){return a.kind==e.cat.contact_information_kinds.predefined("ЮрАдресОрганизации")&&a.presentation?a.presentation:t?t:!a.presentation||a.kind!=e.cat.contact_information_kinds.predefined("ФактАдресОрганизации")&&a.kind!=e.cat.contact_information_kinds.predefined("ПочтовыйАдресОрганизации")?void 0:a.presentation},""),"ОрганизацияТелефон":this.organization.contact_information._obj.reduce(function(t,a){return a.kind==e.cat.contact_information_kinds.predefined("ТелефонОрганизации")&&a.presentation?a.presentation:t?t:a.kind==e.cat.contact_information_kinds.predefined("ФаксОрганизации")&&a.presentation?a.presentation:void 0},""),"ОрганизацияБанкБИК":t.bank.id,"ОрганизацияБанкГород":t.bank.city,"ОрганизацияБанкКоррСчет":t.bank.correspondent_account,"ОрганизацияБанкНаименование":t.bank.name,"ОрганизацияБанкНомерСчета":t.account_number,"ОрганизацияИндивидуальныйПредприниматель":this.organization.individual_entrepreneur.presentation,"ОрганизацияИНН":this.organization.inn,"ОрганизацияКПП":this.organization.kpp,"ОрганизацияСвидетельствоДатаВыдачи":this.organization.certificate_date_issue,"ОрганизацияСвидетельствоКодОргана":this.organization.certificate_authority_code,"ОрганизацияСвидетельствоНаименованиеОргана":this.organization.certificate_authority_name,"ОрганизацияСвидетельствоСерияНомер":this.organization.certificate_series_number,"ОрганизацияЮрФизЛицо":this.organization.individual_legal.presentation,"ПродукцияЭскизы":{},"Проект":this.project.presentation,"СистемыПрофилей":this.sys_profile,"СистемыФурнитуры":this.sys_furn,"Сотрудник":this.manager.presentation,"СотрудникДолжность":this.manager.individual_person.Должность||"менеджер","СотрудникДолжностьРП":this.manager.individual_person.ДолжностьРП,"СотрудникИмя":this.manager.individual_person.Имя,"СотрудникИмяРП":this.manager.individual_person.ИмяРП,"СотрудникОснованиеРП":this.manager.individual_person.ОснованиеРП,"СотрудникОтчество":this.manager.individual_person.Отчество,"СотрудникОтчествоРП":this.manager.individual_person.ОтчествоРП,"СотрудникФамилия":this.manager.individual_person.Фамилия,"СотрудникФамилияРП":this.manager.individual_person.ФамилияРП,"СотрудникФИО":this.manager.individual_person.Фамилия+(this.manager.individual_person.Имя?" "+this.manager.individual_person.Имя[1].toUpperCase()+".":"")+(this.manager.individual_person.Отчество?" "+this.manager.individual_person.Отчество[1].toUpperCase()+".":""),"СотрудникФИОРП":this.manager.individual_person.ФамилияРП+" "+this.manager.individual_person.ИмяРП+" "+this.manager.individual_person.ОтчествоРП,"СуммаДокумента":this.doc_amount.toFixed(2),"СуммаДокументаПрописью":this.doc_amount.in_words(),"СуммаДокументаБезСкидки":this.goods._obj.reduce(function(e,t){return e+t.quantity*t.price},0).toFixed(2)+this.service._obj.reduce(function(e,t){return e+t.quantity*t.price},0).toFixed(2),"СуммаСкидки":this.goods._obj.reduce(function(e,t){return e+t.discount},0).toFixed(2)+this.servise._obj.reduce(function(e,t){return e+t.discount},0).toFixed(2),"СуммаНДС":this.goods._obj.reduce(function(e,t){return e+t.vat_amount},0).toFixed(2)+this.servise._obj.reduce(function(e,t){return e+t.vat_amount},0).toFixed(2),"ТекстНДС":this.vat_consider?this.vat_included?"В том числе НДС 18%":"НДС 18% (сверху)":"Без НДС","ТелефонПоАдресуДоставки":this.phone,"СуммаВключаетНДС":this.contract.vat_included,"УчитыватьНДС":this.contract.vat_consider,"ВсегоНаименований":this.goods.count()+this.service.count(),"ВсегоИзделий":0,"ВсегоПлощадьИзделий":0};this.extra_fields.forEach(function(e){n["Свойство"+e.property.name.replace(/\s/g,"")]=e.value.presentation||e.value}),this.shipping_address?n.МонтажДоставкаСамовывоз="Монтаж по адресу: "+this.shipping_address:n.МонтажДоставкаСамовывоз="Самовывоз";for(var i in this.organization._attachments)if(i.indexOf("logo")!=-1){a.push(this.organization.get_attachment(i).then(function(t){return e.utils.blob_as_text(t,t.type.indexOf("svg")==-1?"data_url":"")}).then(function(e){n.ОрганизацияЛоготип=e})["catch"](e.record_log));break}return(a.length?Promise.all(a):Promise.resolve([])).then(function(){if(!window.QRCode)return new Promise(function(t,a){e.load_script("lib/qrcodejs/qrcode.js","script",t)})}).then(function(){var e=document.createElement("SVG");e.innerHTML="<g />";new QRCode(e,{text:"http://www.oknosoft.ru/zd/",width:100,height:100,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H,useSVG:!0});return n.qrcode=e.innerHTML,n})}},row_description:{value:function(e){var t=e.characteristic,a={"НомерСтроки":e.row,"Количество":e.quantity,"Ед":e.unit.name||"шт","Цвет":t.clr.name,"Размеры":e.len+"x"+e.width+", "+e.s+"м²","Номенклатура":e.nom.name_full||e.nom.name,"Характеристика":t.name,"Заполнения":"","Цена":e.price,"ЦенаВнутр":e.price_internal,"СкидкаПроцент":e.discount_percent,"СкидкаПроцентВнутр":e.discount_percent_internal,"Скидка":e.discount,"Сумма":e.amount,"СуммаВнутр":e.amount_internal};return t.glasses.forEach(function(e){a.Заполнения.indexOf(e.nom.name)==-1&&(a.Заполнения&&(a.Заполнения+=", "),a.Заполнения+=e.nom.name)}),a}}})}),$p.modifiers.push(function(e){var t=e.doc.buyers_order;t.form_list=function(a,n){function i(t){function a(){switch(t){case"execution":e.doc.buyers_order.rep_invoice_execution(c);break;case"plan":case"underway":case"manufactured":case"executed":e.doc.buyers_order.rep_planing(c,t)}}s.cells("report").setActive(),c?c._online&&a():c=new e.HandsontableDocument(s.cells("report"),{}).then(function(e){return e._online?void a():c=null})}n||(n={hide_header:!0,date_from:new Date((new Date).getFullYear().toFixed()+"-01-01"),date_till:new Date((new Date).getFullYear().toFixed()+"-12-31"),on_new:function(a){e.iface.set_hash(t.class_name,a.ref)},on_edit:function(t,a){e.iface.set_hash(t.class_name,a)}});var r=a.attachLayout({pattern:"2U",cells:[{id:"a",text:"Фильтр",collapsed_text:"Фильтр",width:180},{id:"b",text:"Заказы",header:!1}],offsets:{top:0,right:0,bottom:0,left:0}}),o=r.cells("a").attachTree(),s=r.cells("b").attachCarousel({keys:!1,touch_scroll:!1,offset_left:0,offset_top:0,offset_item:0});s.hideControls(),s.addCell("list"),s.addCell("report"),s.conf.anim_step=200,s.conf.anim_slide="left 0.1s";var c,l=t.form_selection(s.cells("list"),n),_={},d={};return _.__define({value:{get:function(){switch(o.getSelectedItemId()){case"draft":case"sent":case"declined":case"confirmed":case"service":case"complaints":case"template":case"zarchive":return"doc/doc_calc_order_date";case"execution":case"plan":case"underway":case"manufactured":case"executed":case"all":return""}}}}),d.__define({value:{get:function(){var e,t;switch(t=o.getSelectedItemId()){case"draft":case"sent":case"declined":case"confirmed":case"service":case"complaints":case"template":case"zarchive":e=t;break;case"execution":case"plan":case"underway":case"manufactured":case"executed":case"all":return""}var a=l.elmnts.filter.get_filter(!0);return{startkey:[e,a.date_from.getFullYear(),a.date_from.getMonth()+1,a.date_from.getDate()],endkey:[e,a.date_till.getFullYear(),a.date_till.getMonth()+1,a.date_till.getDate()],_drop_date:!0,_order_by:!0,_search:a.filter.toLowerCase()}}}}),l.elmnts.filter.custom_selection._view=_,l.elmnts.filter.custom_selection._key=d,l.elmnts.svgs=new e.iface.OSvgs(e.doc.buyers_order,l,l.elmnts.status_bar),l.elmnts.grid.attachEvent("onRowSelect",function(e){l.elmnts.svgs.reload(e)}),o.enableTreeImages(!1),o.parse(e.injected_data["tree_filteres.xml"]),o.attachEvent("onSelect",function(e){switch(e){case"draft":case"sent":case"declined":case"confirmed":case"service":case"complaints":case"template":case"zarchive":case"all":return s.cells("list").setActive(),void l.elmnts.filter.call_event()}i(e)}),l}}),$p.modifiers.push(function(e){var t,a=e.doc.buyers_order;a.form_obj=function(n,i){function r(t){switch(t){case"btn_sent":l("sent");break;case"btn_save":l("save");break;case"btn_save_close":l("close");break;case"btn_retrieve":l("retrieve");break;case"btn_post":l("post");break;case"btn_unpost":l("unpost");break;case"btn_close":p.close();break;case"btn_add_builder":open_builder(!0);break;case"btn_add_product":e.dp.buyers_order.form_product_list(p,process_add_product);break;case"btn_add_material":add_material();break;case"btn_edit":open_builder();break;case"btn_spec":open_spec();break;case"btn_discount":break;case"btn_calendar":o();break;case"btn_go_connection":s()}"prn_"==t.substr(0,4)&&a.print(u,t,p)}function o(){e.msg.show_not_implemented()}function s(){e.msg.show_not_implemented()}function c(){p.elmnts.discount||(p.elmnts.discount=p.elmnts.discount_pop.attachForm([{type:"fieldset",name:"discounts",label:"Скидки по группам",width:220,list:[{type:"settings",position:"label-left",labelWidth:100,inputWidth:50},{type:"input",label:"На продукцию",name:"production",numberFormat:["0.0 %","","."]},{type:"input",label:"На аксессуары",name:"accessories",numberFormat:["0.0 %","","."]},{type:"input",label:"На услуги",name:"services",numberFormat:["0.0 %","","."]}]},{type:"button",name:"btn_discounts",value:"Ок",tooltip:"Установить скидки"}]),p.elmnts.discount.setItemValue("production",0),p.elmnts.discount.setItemValue("accessories",0),p.elmnts.discount.setItemValue("services",0),p.elmnts.discount.attachEvent("onButtonClick",function(e){p.progressOn()}))}function l(t){function a(a){p.elmnts.ro||(u.note=p.elmnts.cell_note.cell.querySelector("textarea").value.replace(/&nbsp;/g," ").replace(/<.*?>/g,"").replace(/&.{2,6};/g,""),p.elmnts.pg_left.selectRow(0)),u.save(a).then(function(){"sent"==t||"close"==t?p.close():(p.set_text(),d())})["catch"](function(t){e.record_log(t)})}"sent"==t?dhtmlx.confirm({title:e.msg.order_sent_title,text:e.msg.order_sent_message,cancel:e.msg.cancel,callback:function(t){t&&(u.obj_delivery_state=e.enm.obj_delivery_states.Отправлен,a())}}):"retrieve"==t?(u.obj_delivery_state=e.enm.obj_delivery_states.Отозван,a()):"save"==t||"close"==t?a():"post"==t?a(!0):"unpost"==t&&a(!1)}function _(){return["vault","vault_pop","discount","discount_pop"].forEach(function(e){p&&p.elmnts&&p.elmnts[e]&&p.elmnts[e].unload&&p.elmnts[e].unload()}),m.forEach(function(t){e.eve.detachEvent(t)}),"function"==typeof f&&f(),!0}function d(){var t,a,n=e.enm.obj_delivery_states.Черновик,i=e.enm.obj_delivery_states.Отозван;p.elmnts.pg_right.cells("vat_consider",1).setDisabled(!0),p.elmnts.pg_right.cells("vat_included",1).setDisabled(!0),p.elmnts.ro=!1,u.obj_delivery_state==e.enm.obj_delivery_states.Шаблон?p.elmnts.ro=!e.current_acl.role_available("ИзменениеТехнологическойНСИ"):u.posted||u._deleted?p.elmnts.ro=!e.current_acl.role_available("СогласованиеРасчетовЗаказов"):p.elmnts.ro||u.obj_delivery_state.empty()||(p.elmnts.ro=u.obj_delivery_state!=n&&u.obj_delivery_state!=i),t=!u._deleted&&(u.obj_delivery_state==e.enm.obj_delivery_states.Отправлен||u.obj_delivery_state==e.enm.obj_delivery_states.Отклонен),p.elmnts.grids.production.setEditable(!p.elmnts.ro),p.elmnts.grids.planning.setEditable(!p.elmnts.ro),p.elmnts.pg_left.setEditable(!p.elmnts.ro),p.elmnts.pg_right.setEditable(!p.elmnts.ro),e.current_acl.role_available("СогласованиеРасчетовЗаказов")||(p.elmnts.frm_toolbar.hideItem("btn_post"),p.elmnts.frm_toolbar.hideItem("btn_unpost")),p.elmnts.ro?(p.elmnts.frm_toolbar.disableItem("btn_sent"),p.elmnts.frm_toolbar.disableItem("btn_save"),a=p.elmnts.tabs.tab_production.getAttachedToolbar(),a.forEachItem(function(e){a.disableItem(e)}),a=p.elmnts.tabs.tab_planning.getAttachedToolbar(),a.forEachItem(function(e){a.disableItem(e)})):(u.obj_delivery_state==e.enm.obj_delivery_states.Шаблон?p.elmnts.frm_toolbar.disableItem("btn_sent"):p.elmnts.frm_toolbar.enableItem("btn_sent"),p.elmnts.frm_toolbar.enableItem("btn_save"),a=p.elmnts.tabs.tab_production.getAttachedToolbar(),a.forEachItem(function(e){a.enableItem(e)}),a=p.elmnts.tabs.tab_planning.getAttachedToolbar(),a.forEachItem(function(e){a.enableItem(e)})),t?p.elmnts.frm_toolbar.enableListOption("bs_more","btn_retrieve"):p.elmnts.frm_toolbar.disableListOption("bs_more","btn_retrieve")}var u,p,m=[],f=i.on_close;return t||(!function(t){e.wsql.get_user_param("hide_price_dealer")?(t.headers="№,Номенклатура,Характеристика,Комментарий,Штук,Длина,Высота,Площадь,Колич.,Ед,Скидка,Цена,Сумма,Скидка&nbsp;дил,Цена&nbsp;дил,Сумма&nbsp;дил",t.widths="40,200,*,220,0,70,70,70,70,40,70,70,70,0,0,0",t.min_widths="30,200,220,150,0,70,40,70,70,70,70,70,70,0,0,0"):e.wsql.get_user_param("hide_price_manufacturer")?(t.headers="№,Номенклатура,Характеристика,Комментарий,Штук,Длина,Высота,Площадь,Колич.,Ед,Скидка&nbsp;пост,Цена&nbsp;пост,Сумма&nbsp;пост,Скидка,Цена,Сумма",t.widths="40,200,*,220,0,70,70,70,70,40,0,0,0,70,70,70",t.min_widths="30,200,220,150,0,70,40,70,70,70,0,0,0,70,70,70"):(t.headers="№,Номенклатура,Характеристика,Комментарий,Штук,Длина,Высота,Площадь,Колич.,Ед,Скидка&nbsp;пост,Цена&nbsp;пост,Сумма&nbsp;пост,Скидка&nbsp;дил,Цена&nbsp;дил,Сумма&nbsp;дил",t.widths="40,200,*,220,0,70,70,70,70,40,70,70,70,70,70,70",t.min_widths="30,200,220,150,0,70,40,70,70,70,70,70,70,70,70,70"),e.current_acl.role_available("СогласованиеРасчетовЗаказов")||e.current_acl.role_available("РедактированиеСкидок")?t.types="cntr,ref,ref,txt,ro,calck,calck,calck,calck,ref,calck,calck,ro,calck,calck,ro":t.types="cntr,ref,ref,txt,ro,calck,calck,calck,calck,ref,ro,ro,ro,calck,calck,ro"}(e.doc.buyers_order.metadata().form.obj.tabular_sections.production),t=!0),i.draw_tabular_sections=function(t,a,n){var i=[];t.production.each(function(t){!e.utils.is_empty_guid(t._obj.characteristic)&&t.characteristic.is_new()&&i.push(t._obj.characteristic)}),e.cat.characteristics.pouch_load_array(i).then(function(){n("production",e.injected_data["toolbar_calc_order_production.xml"]);var t=a.elmnts.tabs.tab_production.getAttachedToolbar();t.addSpacer("btn_delete"),t.attachEvent("onclick",r),n("planning"),a.elmnts.discount_pop=new dhtmlXPopup({toolbar:t,id:"btn_discount"}),a.elmnts.discount_pop.attachEvent("onShow",c),setTimeout(d,50)})},i.draw_pg_header=function(t,a){function n(){setTimeout(function(){a.elmnts.layout_header.setSizes&&(a.elmnts.layout_header.setSizes(),a.elmnts.pg_left.objBox.style.width="100%",a.elmnts.pg_right.objBox.style.width="100%")},200)}a.elmnts.layout_header=a.elmnts.tabs.tab_header.attachLayout("3U"),a.elmnts.layout_header.attachEvent("onResizeFinish",n),a.elmnts.layout_header.attachEvent("onPanelResizeFinish",n),a.elmnts.cell_left=a.elmnts.layout_header.cells("a"),a.elmnts.cell_left.hideHeader(),a.elmnts.pg_left=a.elmnts.cell_left.attachHeadFields({obj:t,pwnd:a,read_only:a.elmnts.ro,oxml:{" ":[{id:"number_doc",path:"o.number_doc",synonym:"Номер",type:"ro",txt:t.number_doc},{id:"date",path:"o.date",synonym:"Дата",type:"ro",txt:e.moment(t.date).format(e.moment._masks.date_time)},"number_internal"],"Контактная информация":["partner","client_of_dealer","phone",{id:"shipping_address",path:"o.shipping_address",synonym:"Адрес доставки",type:"addr",txt:t.shipping_address}],"Дополнительные реквизиты":[{id:"obj_delivery_state",path:"o.obj_delivery_state",synonym:"Состояние транспорта",type:"ro",txt:t.obj_delivery_state.presentation},"category"]}}),a.elmnts.cell_right=a.elmnts.layout_header.cells("b"),a.elmnts.cell_right.hideHeader(),a.elmnts.pg_right=a.elmnts.cell_right.attachHeadFields({obj:t,pwnd:a,read_only:a.elmnts.ro,oxml:{"Налоги":["vat_consider","vat_included"],"Аналитика":["project",{id:"organization",path:"o.organization",synonym:"Организация",type:"refc",txt:t.organization.presentation},"contract","organizational_unit","department"],"Итоги":[{id:"doc_currency",path:"o.doc_currency",synonym:"Валюта документа",type:"ro",txt:t.doc_currency.presentation},{id:"doc_amount",path:"o.doc_amount",synonym:"Сумма",type:"ron",txt:t.doc_amount},{id:"amount_internal",path:"o.amount_internal",synonym:"Сумма внутр",type:"ron",txt:t.amount_internal}]}}),a.elmnts.cell_note=a.elmnts.layout_header.cells("c"),a.elmnts.cell_note.hideHeader(),a.elmnts.cell_note.setHeight(100),a.elmnts.cell_note.attachHTMLString("<textarea class='textarea_editor'>"+t.note+"</textarea>")},i.toolbar_struct=e.injected_data["toolbar_calc_order_obj.xml"],i.toolbar_click=r,i.on_close=_,this.constructor.prototype.form_obj.call(this,n,i).then(function(e){if(e)return u=e.o,p=e.wnd,e})}}),$p.modifiers.push(function(e){e.doc.buyers_order.rep_invoice_execution=function(t){var a={reduce:!0,limit:1e4,group:!0,group_level:3},n={data:[],readOnly:!0,colWidths:[180,180,200,100,100,100,100,100],colHeaders:["Контрагент","Организация","Заказ","Сумма","Оплачено","Долг","Отгружено","Отгрузить"],columns:[{type:"text"},{type:"text"},{type:"text"},{type:"numeric",format:"0 0.00"},{type:"numeric",format:"0 0.00"},{type:"numeric",format:"0 0.00"},{type:"numeric",format:"0 0.00"},{type:"numeric",format:"0 0.00"}],wordWrap:!1};return e.current_acl.role_available("СогласованиеРасчетовЗаказов")||(a.startkey=[e.current_acl.partners_uids[0],""],a.endkey=[e.current_acl.partners_uids[0],"￿"]),e.wsql.pouch.remote.doc.query("server/invoice_execution",a).then(function(a){var i={invoice:0,pay:0,total_pay:0,shipment:0,total_shipment:0};return a.rows&&(a.rows.forEach(function(t){(t.value.total_pay||t.value.total_shipment)&&(n.data.push([e.cat.partners.get(t.key[0]).presentation,e.cat.organizations.get(t.key[1]).presentation,t.key[2],t.value.invoice,t.value.pay,t.value.total_pay,t.value.shipment,t.value.total_shipment]),i.invoice+=t.value.invoice,i.pay+=t.value.pay,i.total_pay+=t.value.total_pay,i.shipment+=t.value.shipment,i.total_shipment+=t.value.total_shipment)}),n.data.push(["Итого:","","",i.invoice,i.pay,i.total_pay,i.shipment,i.total_shipment]),n.mergeCells=[{row:n.data.length-1,col:0,rowspan:1,colspan:3}]),t.requery(n),n})}}),$p.modifiers.push(function(e){function t(e){function t(){return e.doc.nom_prices_setup.pouch_db.query("doc/doc_nom_prices_setup_slice_last",{limit:1e3,include_docs:!1,startkey:[""],endkey:["￿"]}).then(function(t){t.rows.forEach(function(t){var a=e.cat.nom.get(t.key[0],!1,!0);a&&a._data&&(a._data._price||(a._data._price={}),a._data._price[t.key[1]]||(a._data._price[t.key[1]]={}),a._data._price[t.key[1]][t.key[2]]||(a._data._price[t.key[1]][t.key[2]]=[]),a._data._price[t.key[1]][t.key[2]].push({date:new Date(t.value.date),price:t.value.price,currency:e.cat.currencies.get(t.value.currency)}))})})}this.from_currency_to_currency=function(t,a,n,i){if(i&&!i.empty()||(i=e.job_prm.pricing.main_currency),!n||n==i)return t;a||(a=new Date),this.cource_sql||(this.cource_sql=e.wsql.alasql.compile("select top 1 * from `ireg_currency_courses` where `currency` = ? and `period` <= ? order by `date` desc"));var r,o={course:1,multiplicity:1},s={course:1,multiplicity:1};return n!=e.job_prm.pricing.main_currency&&(r=this.cource_sql([n.ref,a]),r.length&&(o=r[0])),i!=e.job_prm.pricing.main_currency&&(r=this.cource_sql([i.ref,a]),r.length&&(s=r[0])),t*o.course/o.multiplicity*s.multiplicity/s.course},e.on({predefined_elmnts_inited:function a(){e.off(a),t()},pouch_change:function(t,a){t!=e.doc.nom_prices_setup.cachable}})}e.pricing=new t(e),e.cat.nom._obj_constructor.prototype.__define({_price:{value:function(t){t||(t={}),t.price_type?e.utils.is_data_obj(t.price_type)&&(t.price_type=t.price_type.ref):t.price_type=e.job_prm.pricing.price_type_sale,t.characteristic?e.utils.is_data_obj(t.characteristic)&&(t.characteristic=t.characteristic.ref):t.characteristic=e.utils.blank.guid,t.date||(t.date=new Date);var a,n=0,i=e.utils.blank.date;return this._data._price&&(this._data._price[t.characteristic]?this._data._price[t.characteristic][t.price_type]&&this._data._price[t.characteristic][t.price_type].forEach(function(e){e.date>i&&e.date<=t.date&&(n=e.price,a=e.currency)}):t.characteristic!=e.utils.blank.guid&&this._data._price[e.utils.blank.guid]&&this._data._price[e.utils.blank.guid][t.price_type]&&this._data._price[e.utils.blank.guid][t.price_type].forEach(function(e){e.date>i&&e.date<=t.date&&(n=e.price,a=e.currency)})),e.pricing.from_currency_to_currency(n,t.date,a,t.currency)}}})}),$p.on({settings:function(e,t){e.__define({local_storage_prefix:{value:"oo_"},skin:{value:"dhx_terrace"},pouch_filter:{value:function(){var e={};return e.__define({doc:{value:"auth/by_partner",writable:!1}}),e}(),writable:!1},guests:{value:[{username:"Дилер",password:"1gNjzYQKBlcD"}]},irest_enabled:{value:!0},rest_path:{value:"/a/zd/%1/odata/standard.odata/"},keep_hash:{value:!0},guest_name:{value:"guest"},guest_pwd:{value:"meta"}}),e.zone=0,e.zone_demo=1,e.couch_path="/couchdb/oo_",e.enable_save_pwd=!0},iface_init:function(){$p.iface.sidebar_items=[{id:"orders",text:"Заказы",icon:"projects_48.png"},{id:"settings",text:"Настройки",icon:"settings_48.png"},{id:"about",text:"О программе",icon:"about_48.png"}],$p.iface.btn_auth_sync=new $p.iface.OBtnAuthSync,$p.iface.btns_nav=function(e){return $p.iface.btn_auth_sync.bind(new $p.iface.OTooolBar({wrapper:e,class_name:"md_otbnav",width:"260px",height:"28px",top:"3px",right:"3px",name:"right",buttons:[{name:"about",text:'<i class="fa fa-info-circle md-fa-lg"></i>',tooltip:"О программе","float":"right"},{name:"settings",text:'<i class="fa fa-cog md-fa-lg"></i>',tooltip:"Настройки","float":"right"},{name:"orders",text:'<i class="fa fa-suitcase md-fa-lg"></i>',tooltip:"Заказы","float":"right"},{name:"sep_0",text:"","float":"right"},{name:"sync",text:"","float":"right"},{name:"auth",text:"",width:"80px","float":"right"}],onclick:function(e){return $p.iface.main.cells(e).setActive(!0),!1}}))}},meta:function(){document.body.removeChild(document.querySelector("#osplash")),$p.iface.main=new dhtmlXSideBar({parent:document.body,icons_path:"dist/imgs/",width:180,header:!0,template:"tiles",autohide:!0,items:$p.iface.sidebar_items,offsets:{top:0,right:0,bottom:0,left:0}}),$p.iface.main.attachEvent("onSelect",function(e){var t=$p.job_prm.parse_url();t.view!=e&&$p.iface.set_hash(t.obj,t.ref,t.frm,e),$p.iface["view_"+e]($p.iface.main.cells(e))}),$p.iface.main.progressOn(),hprm=$p.job_prm.parse_url(),hprm.view&&$p.iface.main.getAllItems().indexOf(hprm.view)!=-1?setTimeout($p.iface.hash_route):$p.iface.set_hash(hprm.obj,hprm.ref,hprm.frm,"orders");
},hash_route:function(e){return e.view&&$p.iface.main.getActiveItem()!=e.view&&$p.iface.main.getAllItems().forEach(function(t){t==e.view&&$p.iface.main.cells(t).setActive(!0)}),!1},predefined_elmnts_inited:function e(){$p.iface.main.progressOff(),$p.off(e),!$p.wsql.pouch.authorized&&navigator.onLine&&$p.wsql.get_user_param("enable_save_pwd")&&$p.wsql.get_user_param("user_name")&&$p.wsql.get_user_param("user_pwd")&&setTimeout(function(){$p.iface.frm_auth({modal_dialog:!0,try_auto:!0})},100)},pouch_load_data_error:function t(e){e.db_name&&e.hasOwnProperty("doc_count")&&e.doc_count<10&&navigator.onLine&&($p.wsql.get_user_param("zone")!=$p.job_prm.zone_demo||$p.wsql.get_user_param("user_name")?$p.iface.frm_auth({modal_dialog:!0,try_auto:$p.wsql.get_user_param("zone")==$p.job_prm.zone_demo&&$p.wsql.get_user_param("enable_save_pwd")}):($p.wsql.set_user_param("enable_save_pwd",!0),$p.wsql.set_user_param("user_name",$p.job_prm.guests[0].username),$p.wsql.set_user_param("user_pwd",$p.job_prm.guests[0].password),setTimeout(function(){$p.iface.frm_auth({modal_dialog:!0,try_auto:!0})},100))),$p.iface.main.progressOff(),$p.off(t)}}),$p.iface.view_about=function(e){function t(){e.attachHTMLString($p.injected_data["view_about.html"]),e.cell.querySelector(".dhx_cell_cont_sidebar").style.overflow="auto",this.tb_nav=$p.iface.btns_nav(e.cell.querySelector(".dhx_cell_sidebar_hdr"))}return $p.iface._about||($p.iface._about=new t)},$p.iface.view_orders=function(e){function t(){function t(){r.carousel.cells("list").setActive(),e.setText({text:"Заказы"}),r.list||(r.carousel.cells("list").detachObject(!0),r.list=$p.doc.buyers_order.form_list(r.carousel.cells("list")))}function a(t){var a=r.carousel.cells("doc");a.setActive(),a.ref&&a.ref==t?r.doc&&r.doc.wnd&&setTimeout(r.doc.wnd.set_text.bind(r.doc.wnd,!0),200):$p.doc.buyers_order.form_obj(a,{ref:t,bind_pwnd:!0,on_close:function(){setTimeout(function(){$p.iface.set_hash(void 0,"","list")})},set_text:function(t){r.carousel.getActiveCell()==a&&e.setText({text:"<b>"+t+"</b>"})}}).then(function(e){r.doc=e,setTimeout(r.doc.wnd.set_text.bind(r.doc.wnd,!0),200)})}function n(e){return"orders"!=e.view||("doc.buyers_order"!=e.obj||$p.utils.is_empty_guid(e.ref)?"doc.buyers_order"!=e.obj?setTimeout(function(){$p.iface.set_hash("doc.buyers_order","","list")}):t():"doc"!=e.frm?setTimeout(function(){$p.iface.set_hash(void 0,void 0,"doc")}):a(e.ref),!1)}function i(){$p.off(i),setTimeout(function(){$p.iface.set_hash($p.job_prm.parse_url().obj||"doc.buyers_order")})}var r=this;r.tb_nav=$p.iface.btns_nav(e.cell.querySelector(".dhx_cell_sidebar_hdr")),r.carousel=e.attachCarousel({keys:!1,touch_scroll:!1,offset_left:0,offset_top:0,offset_item:0}),r.carousel.hideControls(),r.carousel.addCell("list"),r.carousel.addCell("doc"),$p.job_prm.builder?setTimeout(i):$p.on({predefined_elmnts_inited:i}),$p.on("hash_route",n)}return $p.iface._orders||($p.iface._orders=new t)},$p.iface.view_settings=function(e){function t(){function t(e){return"settings"!=e.view}function a(){if(n&&$p.eve.detachEvent(n),i.form2.isLocked()&&i.form2.unlock(),$p.wsql.get_user_param("hide_price_dealer")?i.form2.checkItem("hide_price","hide_price_dealer"):$p.wsql.get_user_param("hide_price_manufacturer")?i.form2.checkItem("hide_price","hide_price_manufacturer"):i.form2.checkItem("hide_price","hide_price_no"),$p.current_acl.partners_uids.length){var e=$p.cat.partners.get($p.current_acl.partners_uids[0]),t={calc_order_row:{nom:$p.cat.nom.get(),_owner:{_owner:{partner:e}}}};$p.pricing.price_type(t),i.form2.setItemValue("surcharge_internal",t.price_type.extra_charge_external)}else i.form2.disableItem("surcharge_internal"),i.form2.disableItem("discount_percent_internal");i.form2.attachEvent("onChange",function(e,t,a){"hide_price"==e&&("hide_price_dealer"==t?($p.wsql.set_user_param("hide_price_dealer",!0),$p.wsql.set_user_param("hide_price_manufacturer","")):"hide_price_manufacturer"==t?($p.wsql.set_user_param("hide_price_dealer",""),$p.wsql.set_user_param("hide_price_manufacturer",!0)):($p.wsql.set_user_param("hide_price_dealer",""),$p.wsql.set_user_param("hide_price_manufacturer","")))}),i.form2.getInput("modifiers").onchange=function(){$p.wsql.set_user_param("modifiers",this.value)}}var n,i=this;i.tb_nav=$p.iface.btns_nav(e.cell.querySelector(".dhx_cell_sidebar_hdr")),i.tabs=e.attachTabbar({arrows_mode:"auto",tabs:[{id:"const",text:'<i class="fa fa-key"></i> Общее',active:!0},{id:"industry",text:'<i class="fa fa-industry"></i> Технология'},{id:"price",text:'<i class="fa fa-money"></i> Учет'},{id:"events",text:'<i class="fa fa-calendar-check-o"></i> Планирование'}]}),i.tabs.attachEvent("onSelect",function(e){return i[e]&&i[e].tree&&i[e].tree.getSelectedItemId()&&i[e].tree.callEvent("onSelect",[i[e].tree.getSelectedItemId()]),!0}),i.tabs.cells("const").attachHTMLString($p.injected_data["view_settings.html"]),i["const"]=i.tabs.cells("const").cell.querySelector(".dhx_cell_cont_tabbar"),i["const"].style.overflow="auto",i.form1=i["const"].querySelector("[name=form1]"),i.form1=new dhtmlXForm(i.form1.firstChild,[{type:"settings",labelWidth:80,position:"label-left"},{type:"label",labelWidth:320,label:"Тип устройства",className:"label_options"},{type:"block",blockOffset:0,name:"block_device_type",list:[{type:"settings",labelAlign:"left",position:"label-right"},{type:"radio",name:"device_type",labelWidth:120,label:'<i class="fa fa-desktop"></i> Компьютер',value:"desktop"},{type:"newcolumn"},{type:"radio",name:"device_type",labelWidth:150,label:'<i class="fa fa-mobile fa-lg"></i> Телефон, планшет',value:"phone"}]},{type:"template",label:"",value:"",note:{text:"Класс устройства определяется автоматически, но пользователь может задать его явно",width:320}},{type:"label",labelWidth:320,label:"Адрес CouchDB",className:"label_options"},{type:"input",inputWidth:220,name:"couch_path",label:"Путь:",validate:"NotEmpty"},{type:"template",label:"",value:"",note:{text:"Можно указать как относительный, так и абсолютный URL публикации CouchDB",width:320}},{type:"label",labelWidth:320,label:"Значение разделителя данных",className:"label_options"},{type:"input",inputWidth:220,name:"zone",label:"Зона:",numberFormat:["0","",""],validate:"NotEmpty,ValidInteger"},{type:"template",label:"",value:"",note:{text:"Для неразделенной публикации, зона = 0",width:320}},{type:"label",labelWidth:320,label:"Суффикс базы пользователя",className:"label_options"},{type:"input",inputWidth:220,name:"couch_suffix",label:"Суффикс:"},{type:"template",label:"",value:"",note:{text:"Назначается дилеру при регистрации",width:320}},{type:"label",labelWidth:320,label:"Сохранять пароль пользователя",className:"label_options"},{type:"checkbox",name:"enable_save_pwd",label:"Разрешить:",checked:$p.wsql.get_user_param("enable_save_pwd","boolean")},{type:"template",label:"",value:"",note:{text:"Не рекомендуется, если к компьютеру имеют доступ посторонние лица",width:320}},{type:"template",label:"",value:"",note:{text:"",width:320}},{type:"block",blockOffset:0,name:"block_buttons",list:[{type:"button",name:"save",value:"<i class='fa fa-floppy-o fa-lg'></i>",tooltip:"Применить настройки и перезагрузить программу"},{type:"newcolumn"},{type:"button",offsetLeft:20,name:"reset",value:"<i class='fa fa-refresh fa-lg'></i>",tooltip:"Стереть справочники и перезаполнить данными сервера"},{type:"newcolumn"},{type:"button",offsetLeft:60,name:"upload",value:"<i class='fa fa-cloud-upload fa-lg'></i>",tooltip:"Выгрузить изменения справочников на сервер"}]}]),i.form1.cont.style.fontSize="100%",i.form1.checkItem("device_type",$p.job_prm.device_type),["zone","couch_path","couch_suffix"].forEach(function(e){"zone"==e?i.form1.setItemValue(e,$p.wsql.get_user_param(e)):i.form1.setItemValue(e,$p.wsql.get_user_param(e)||$p.job_prm[e])}),i.form1.attachEvent("onChange",function(e,t,a){$p.wsql.set_user_param(e,"enable_save_pwd"==e?a||"":t)}),i.form1.attachEvent("onButtonClick",function(e){"save"==e?location.reload():"reset"==e?dhtmlx.confirm({title:"Сброс данных",text:"Стереть справочники и перезаполнить данными сервера?",cancel:$p.msg.cancel,callback:function(e){e&&$p.wsql.pouch.reset_local_data()}}):"upload"==e&&$p.pricing.cut_upload()}),i.form2=i["const"].querySelector("[name=form2]"),i.form2=new dhtmlXForm(i.form2.firstChild,[{type:"settings",labelWidth:220,position:"label-left"},{type:"label",labelWidth:320,label:"Колонки цен",className:"label_options"},{type:"block",blockOffset:0,name:"block_hide_price",list:[{type:"settings",labelAlign:"left",position:"label-right"},{type:"radio",name:"hide_price",label:'<i class="fa fa-eye fa-fw"></i> Показывать все цены',value:"hide_price_no"},{type:"radio",name:"hide_price",label:'<i class="fa fa-user-secret fa-fw"></i> Скрыть цены дилера',value:"hide_price_dealer"},{type:"radio",name:"hide_price",label:'<i class="fa fa-university fa-fw"></i> Скрыть цены завода',value:"hide_price_manufacturer"}]},{type:"template",label:"",value:"",note:{text:"Настройка видимости колонок в документе 'Расчет' и графическом построителе",width:320}},{type:"label",labelWidth:320,label:"Наценки и скидки",className:"label_options"},{type:"input",labelWidth:180,inputWidth:120,name:"surcharge_internal",label:"Наценка дилера, %:",numberFormat:["0","",""],validate:"NotEmpty,ValidInteger"},{type:"input",labelWidth:180,inputWidth:120,name:"discount_percent_internal",label:"Скидка дилера, %:",numberFormat:["0","",""],validate:"NotEmpty,ValidInteger"},{type:"template",label:"",value:"",note:{text:"Значения наценки и скидки по умолчанию, которые дилер предоставляет своим (конечным) покупателям",width:320}},{type:"label",labelWidth:320,label:"Подключаемые модули",className:"label_options"},{type:"input",position:"label-top",inputWidth:320,name:"modifiers",label:"Модификаторы:",value:$p.wsql.get_user_param("modifiers"),rows:3,style:"height:80px;"},{type:"template",label:"",value:"",note:{text:"Список дополнительных модулей",width:320}}]),i.form2.cont.style.fontSize="100%",$p.cat.partners.alatable.length&&$p.current_acl?a():(i.form2.lock(),n=$p.eve.attachEvent("predefined_elmnts_inited",a)),i.industry={layout:i.tabs.cells("industry").attachLayout({pattern:"2U",cells:[{id:"a",text:"Разделы",collapsed_text:"Разделы",width:200},{id:"b",text:"Раздел",header:!1}],offsets:{top:0,right:0,bottom:0,left:0}})},i.industry.tree=i.industry.layout.cells("a").attachTree(),i.industry.tree.enableTreeImages(!1),i.industry.tree.parse($p.injected_data["tree_industry.xml"]),i.industry.tree.attachEvent("onSelect",function(e){$p.md.mgr_by_class_name(e).form_list(i.industry.layout.cells("b"),{hide_header:!0})}),i.price={layout:i.tabs.cells("price").attachLayout({pattern:"2U",cells:[{id:"a",text:"Разделы",collapsed_text:"Разделы",width:200},{id:"b",text:"Раздел",header:!1}],offsets:{top:0,right:0,bottom:0,left:0}})},i.price.tree=i.price.layout.cells("a").attachTree(),i.price.tree.enableTreeImages(!1),i.price.tree.parse($p.injected_data["tree_price.xml"]),i.price.tree.attachEvent("onSelect",function(e){$p.md.mgr_by_class_name(e).form_list(i.price.layout.cells("b"),{hide_header:!0})}),i.events={layout:i.tabs.cells("events").attachLayout({pattern:"2U",cells:[{id:"a",text:"Разделы",collapsed_text:"Разделы",width:200},{id:"b",text:"Раздел",header:!1}],offsets:{top:0,right:0,bottom:0,left:0}})},i.events.tree=i.events.layout.cells("a").attachTree(),i.events.tree.enableTreeImages(!1),i.events.tree.parse($p.injected_data["tree_events.xml"]),i.events.tree.attachEvent("onSelect",function(e){$p.md.mgr_by_class_name(e).form_list(i.events.layout.cells("b"),{hide_header:!0})}),$p.on("hash_route",t)}return $p.iface._settings||($p.iface._settings=new t)}});